{"total_count": 32, "incomplete_results": false, "items": [{"url": "https://api.github.com/repos/respeaker/seeed-voicecard/issues/336", "repository_url": "https://api.github.com/repos/respeaker/seeed-voicecard", "labels_url": "https://api.github.com/repos/respeaker/seeed-voicecard/issues/336/labels{/name}", "comments_url": "https://api.github.com/repos/respeaker/seeed-voicecard/issues/336/comments", "events_url": "https://api.github.com/repos/respeaker/seeed-voicecard/issues/336/events", "html_url": "https://github.com/respeaker/seeed-voicecard/pull/336", "id": 1659914767, "node_id": "PR_kwDOBXvt7s5N4997", "number": 336, "title": "Fix get_kernel_version() to get dpkg to look for the right headers", "user": {"login": "GuillaumeRossolini", "id": 8587631, "node_id": "MDQ6VXNlcjg1ODc2MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/8587631?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeRossolini", "html_url": "https://github.com/GuillaumeRossolini", "followers_url": "https://api.github.com/users/GuillaumeRossolini/followers", "following_url": "https://api.github.com/users/GuillaumeRossolini/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeRossolini/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeRossolini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeRossolini/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeRossolini/orgs", "repos_url": "https://api.github.com/users/GuillaumeRossolini/repos", "events_url": "https://api.github.com/users/GuillaumeRossolini/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeRossolini/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2023-04-09T15:35:42Z", "updated_at": "2023-04-12T10:53:23Z", "closed_at": "2023-04-11T14:44:38Z", "author_association": "NONE", "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/respeaker/seeed-voicecard/pulls/336", "html_url": "https://github.com/respeaker/seeed-voicecard/pull/336", "diff_url": "https://github.com/respeaker/seeed-voicecard/pull/336.diff", "patch_url": "https://github.com/respeaker/seeed-voicecard/pull/336.patch", "merged_at": null}, "body": "The following is using HinTak's repository on the v6.1 branch, on a Raspberry Pi Zero W with the Raspberry Pi OS Lite (32-bit) image.\r\n```\r\n$ uname -r\r\n6.1.21+\r\n```\r\n\r\nExecuting ./install.sh on a raspberry zero w, recently reimaged, with barely anything installed on top of the default image (certainly nothing kernel-related), results in errors along these lines:\r\n\r\n```\r\nsudo ./install.sh\r\nHit:1 http://raspbian.raspberrypi.org/raspbian bullseye InRelease\r\nHit:2 http://archive.raspberrypi.org/debian bullseye InRelease\r\nReading package lists... Done\r\nBuilding dependency tree... Done\r\nReading state information... Done\r\n4 packages can be upgraded. Run 'apt list --upgradable' to see them.\r\nReading package lists... Done\r\nBuilding dependency tree... Done\r\nReading state information... Done\r\nraspberrypi-kernel is already the newest version (1:1.20230405-1).\r\nraspberrypi-kernel-headers is already the newest version (1:1.20230405-1).\r\n0 upgraded, 0 newly installed, 0 to remove and 4 not upgraded.\r\nReading package lists... Done\r\nBuilding dependency tree... Done\r\nReading state information... Done\r\nE: Unable to locate package linux-raspi\r\nE: Unable to locate package linux-headers-raspi\r\nE: Unable to locate package linux-image-raspi\r\nReading package lists... Done\r\nBuilding dependency tree... Done\r\nReading state information... Done\r\ndkms is already the newest version (2.8.4-3).\r\ngit is already the newest version (1:2.30.2-1+deb11u2).\r\ni2c-tools is already the newest version (4.2-1+b1).\r\nlibasound2-plugins is already the newest version (1.2.2-2).\r\n0 upgraded, 0 newly installed, 0 to remove and 4 not upgraded.\r\ndpkg-query: package 'linux-headers-' is not installed\r\ndpkg-query: package '6.1.21+' is not installed\r\nUse dpkg --contents (= dpkg-deb --contents) to list archive files contents.\r\n !!! Your kernel version is\r\n\r\n\r\n\r\n\r\n\r\n6.1.21+\r\n     Not found *** corresponding *** kernel headers with apt-get.\r\n     This may occur if you have ran 'rpi-update'.\r\n Choose  *** y *** will revert the kernel to version  then continue.\r\n Choose  *** N *** will exit without this driver support, by default.\r\nWould you like to proceed? (y/N)\r\nReading package lists... Done\r\nBuilding dependency tree... Done\r\nReading state information... Done\r\n0 upgraded, 0 newly installed, 1 reinstalled, 0 to remove and 4 not upgraded.\r\nNeed to get 0 B/102 MB of archives.\r\nAfter this operation, 0 B of additional disk space will be used.\r\n(Reading database ... 101414 files and directories currently installed.)\r\nPreparing to unpack .../raspberrypi-kernel_1%3a1.20230405-1_armhf.deb ...\r\n```\r\nThe above is a trimmed log, and the script then tries to apply kernel headers that don't match my system. I then get a scary fullscreen warning that tells me to please reboot, but when I do and reinstall, the same happens.\r\n\r\nI'll focus on these warnings from the log above (and the messages that follow):\r\n```\r\ndpkg-query: package 'linux-headers-' is not installed\r\ndpkg-query: package '6.1.21+' is not installed\r\n```\r\n\r\nFrom what I understand, the issue is with the `get_kernel_version()` macro and specifically this line:\r\n```\r\n$ dd if=$ZIMAGE obs=64K ibs=4 skip=$(( IMG_OFFSET / 4)) 2>/dev/null | zcat | grep -a -m1 \"Linux version\" | strings\r\ninitcall_blacklist\r\nsetup_command_line\r\nprint_unknown_bootoptions\r\ndo_initcalls\r\ninitcall_debug\r\ninitcall\r\nLinux version 6.1.21+ (dom@buildbot) (arm-linux-gnueabihf-gcc-8 (Ubuntu/Linaro 8.4.0-3ubuntu1) 8.4.0, GNU ld (GNU Binutils for Ubuntu) 2.34) #\r\n```\r\n\r\nWhen this gets piped into `awk`, a lot of empty lines stay in the output, confusing the `dpkg` commands later on.\r\n\r\n`aplay whatever.wav` still works without this.\r\n\r\nI'm not sure this is the best fix, or if it should be applied in other scripts.", "reactions": {"url": "https://api.github.com/repos/respeaker/seeed-voicecard/issues/336/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/respeaker/seeed-voicecard/issues/336/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]}