{"total_count": 36, "incomplete_results": false, "items": [{"url": "https://api.github.com/repos/robbert-vdh/nih-plug/issues/84", "repository_url": "https://api.github.com/repos/robbert-vdh/nih-plug", "labels_url": "https://api.github.com/repos/robbert-vdh/nih-plug/issues/84/labels{/name}", "comments_url": "https://api.github.com/repos/robbert-vdh/nih-plug/issues/84/comments", "events_url": "https://api.github.com/repos/robbert-vdh/nih-plug/issues/84/events", "html_url": "https://github.com/robbert-vdh/nih-plug/issues/84", "id": 1889372997, "node_id": "I_kwDOGusTJM5wnYtF", "number": 84, "title": "Subtle eroding of velocity values (CLAP only)", "user": {"login": "ijijn", "id": 6064114, "node_id": "MDQ6VXNlcjYwNjQxMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6064114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ijijn", "html_url": "https://github.com/ijijn", "followers_url": "https://api.github.com/users/ijijn/followers", "following_url": "https://api.github.com/users/ijijn/following{/other_user}", "gists_url": "https://api.github.com/users/ijijn/gists{/gist_id}", "starred_url": "https://api.github.com/users/ijijn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ijijn/subscriptions", "organizations_url": "https://api.github.com/users/ijijn/orgs", "repos_url": "https://api.github.com/users/ijijn/repos", "events_url": "https://api.github.com/users/ijijn/events{/privacy}", "received_events_url": "https://api.github.com/users/ijijn/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-09-10T22:54:46Z", "updated_at": "2023-09-19T00:40:03Z", "closed_at": "2023-09-16T15:58:30Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hi again folks!\r\n\r\nI recently noticed a weird thing, after much scratching of the head, that whenever I put an nih-plug CLAP plugin on a track, processed MIDI events would generally decrease their velocity by a small amount: most notes would lose 1 \"point\" of velocity per instance, while some would remain unchanged. Other details, such as CC values, were unaffected, however. For reference, this was with the latest Reaper version on Windows 11, even for plugins that do _absolutely nothing_ to the MIDI (see the bottom of this post for a quick example).\r\n\r\nI tried the equivalent VST3 builds and everything was fine. I considered that this could be a fault in Reaper's handling of CLAP, but I downloaded another CLAP plugin to see (namely, Ny by Full Bucket Music) and that one's MIDI-thru worked perfectly.\r\n\r\nAfter this initial round of testing, I thought that maybe there was a calibration error between the velocity values of nih-plug and CLAP, and that does indeed seem to be the case: as far as I can tell, CLAP's `f64` velocities operate on a range from 0.0 (0) to 1.0 (128) (i.e. `value / 128.0`) whereas here we use `value / 127.0` for our `f32`s (EDIT: oops, wrote that backwards before). In any case, I patched the velocity conversion logic and the problem went away completely, working across the full range of inputs. A pull request is incoming with these minor changes for consideration.\r\n\r\nThanks as always and all the best,\r\nIain\r\n\r\n```rust\r\nuse std::sync::Arc;\r\n\r\nuse nih_plug::prelude::*;\r\n\r\n#[derive(Default, Params)]\r\npub struct PluginParams {}\r\n\r\n#[derive(Default)]\r\npub struct Stub {\r\n    params: Arc<PluginParams>,\r\n}\r\n\r\nimpl Plugin for Stub {\r\n    const NAME: &'static str = \"stub\";\r\n    const VENDOR: &'static str = \"stubby stubbins\";\r\n    const URL: &'static str = \"[stub.org](http://stub.org/)\";\r\n    const EMAIL: &'static str = \"[stubby@stub.org](mailto:stubby@stub.org)\";\r\n    const VERSION: &'static str = env!(\"CARGO_PKG_VERSION\");\r\n    const AUDIO_IO_LAYOUTS: &'static [AudioIOLayout] = &[];\r\n    const MIDI_INPUT: MidiConfig = MidiConfig::MidiCCs;\r\n    const MIDI_OUTPUT: MidiConfig = MidiConfig::MidiCCs;\r\n    const SAMPLE_ACCURATE_AUTOMATION: bool = true;\r\n\r\n    type SysExMessage = ();\r\n    type BackgroundTask = ();\r\n\r\n    fn params(&self) -> Arc<dyn Params> {\r\n        self.params.clone()\r\n    }\r\n\r\n    fn process(\r\n        &mut self,\r\n        _buffer: &mut Buffer,\r\n        _aux: &mut AuxiliaryBuffers,\r\n        context: &mut impl ProcessContext<Self>,\r\n    ) -> ProcessStatus {\r\n        while let Some(event) = context.next_event() {\r\n            context.send_event(event);\r\n        }\r\n\r\n        ProcessStatus::Normal\r\n    }\r\n\r\n    fn editor(&mut self, _async_executor: AsyncExecutor<Self>) -> Option<Box<dyn Editor>> {\r\n        None\r\n    }\r\n\r\n    fn initialize(\r\n        &mut self,\r\n        _audio_io_layout: &AudioIOLayout,\r\n        _buffer_config: &BufferConfig,\r\n        _context: &mut impl InitContext<Self>,\r\n    ) -> bool {\r\n        true\r\n    }\r\n}\r\n\r\nimpl ClapPlugin for Stub {\r\n    const CLAP_ID: &'static str = \"org.stub.stubby\";\r\n    const CLAP_DESCRIPTION: Option<&'static str> = None;\r\n    const CLAP_MANUAL_URL: Option<&'static str> = None;\r\n    const CLAP_SUPPORT_URL: Option<&'static str> = None;\r\n    const CLAP_FEATURES: &'static [ClapFeature] = &[ClapFeature::NoteEffect, ClapFeature::Utility];\r\n}\r\n\r\nimpl Vst3Plugin for Stub {\r\n    const VST3_CLASS_ID: [u8; 16] = *b\"stubstubstubstub\";\r\n    const VST3_SUBCATEGORIES: &'static [Vst3SubCategory] =\r\n        &[Vst3SubCategory::Instrument, Vst3SubCategory::Tools];\r\n}\r\n\r\nnih_export_clap!(Stub);\r\nnih_export_vst3!(Stub);\r\n```", "reactions": {"url": "https://api.github.com/repos/robbert-vdh/nih-plug/issues/84/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/robbert-vdh/nih-plug/issues/84/timeline", "performed_via_github_app": null, "state_reason": "not_planned", "score": 1.0}]}